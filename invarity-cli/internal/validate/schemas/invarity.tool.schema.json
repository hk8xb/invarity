{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://invarity.ai/schemas/invarity.tool.schema.v3.json",
  "title": "Invarity Tool Definition (Conventional Tool + invarity block, v3 â€” required tool-level constraints)",
  "type": "object",
  "additionalProperties": true,
  "required": ["name", "description", "invarity"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Provider-facing tool name (OpenAI/Claude/LangChain). Recommended: snake_case, <=64 chars.",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-zA-Z0-9_\\-\\.]{1,64}$"
    },
    "description": {
      "type": "string",
      "description": "Human description of what the tool does.",
      "minLength": 1,
      "maxLength": 2000
    },

    "parameters": {
      "type": "object",
      "description": "OpenAI-style tool args schema (JSON Schema). Must be a strict object schema.",
      "required": ["type", "additionalProperties"],
      "properties": {
        "type": { "const": "object" },
        "additionalProperties": { "const": false }
      },
      "additionalProperties": true
    },
    "input_schema": {
      "type": "object",
      "description": "Claude-style tool input schema (JSON Schema). Must be a strict object schema.",
      "required": ["type", "additionalProperties"],
      "properties": {
        "type": { "const": "object" },
        "additionalProperties": { "const": false }
      },
      "additionalProperties": true
    },

    "invarity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "version", "risk", "constraints"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Opaque tool identifier (stable across versions). Flexible format.",
          "minLength": 1,
          "maxLength": 256
        },
        "version": {
          "type": "string",
          "description": "Immutable semantic version for this tool definition.",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-.]+)?(?:\\+[0-9A-Za-z-.]+)?$"
        },
        "schema_hash": {
          "type": "string",
          "description": "Optional. Server/CLI can compute. Format: sha256:<hex>.",
          "pattern": "^sha256:[a-f0-9]{64}$"
        },

        "risk": {
          "type": "object",
          "additionalProperties": false,
          "description": "MVP: user-declared risk tier for routing safeguards.",
          "required": ["base_risk", "operation", "requires_human_review"],
          "properties": {
            "base_risk": {
              "type": "string",
              "enum": ["low", "medium", "high", "critical"]
            },
            "operation": {
              "type": "string",
              "enum": ["read", "write", "delete", "execute"]
            },
            "requires_human_review": {
              "type": "boolean",
              "description": "If true, Invarity should ESCALATE (or require approval) even if intent aligns."
            },
            "tags": {
              "type": "array",
              "description": "Optional customer labels for routing/reporting (no inference implied).",
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 64,
                "pattern": "^[a-z0-9_\\-\\.]{1,64}$"
              },
              "maxItems": 32,
              "uniqueItems": true
            },
            "notes": {
              "type": "string",
              "maxLength": 2000
            }
          }
        },

        "constraints": {
          "type": "object",
          "additionalProperties": false,
          "description": "Tool-level policy (required). MUST be small and mechanically enforceable. No prose policies.",
          "required": [
            "requires_justification",
            "required_args",
            "disallow_wildcards",
            "max_bulk",
            "amount_limit"
          ],
          "properties": {
            "requires_justification": {
              "type": "boolean",
              "description": "If true, every invocation must include a non-empty justification string in the request envelope."
            },

            "required_args": {
              "type": "array",
              "description": "Args that MUST be present for invocation. Keep minimal; no nested paths in v3.",
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 64,
                "pattern": "^[A-Za-z0-9_\\-\\.]{1,64}$"
              },
              "minItems": 0,
              "maxItems": 32,
              "uniqueItems": true
            },

            "disallow_wildcards": {
              "type": "boolean",
              "description": "If true, reject obvious wildcard/broadcast patterns in args (e.g. '*', 'ALL', empty filter objects)."
            },

            "max_bulk": {
              "description": "Maximum allowed bulk size (deterministic). Use null if not applicable.",
              "oneOf": [
                { "type": "null" },
                { "type": "integer", "minimum": 1, "maximum": 1000000 }
              ]
            },

            "amount_limit": {
              "description": "Money movement limit (deterministic). Use null if not applicable. Unit is customer-defined (recommend cents) and documented by the tool.",
              "oneOf": [
                { "type": "null" },
                {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["max", "currency", "arg_key"],
                  "properties": {
                    "max": {
                      "type": "number",
                      "minimum": 0
                    },
                    "currency": {
                      "type": "string",
                      "description": "ISO currency code (or 'N/A' if the tool uses a unit like cents without currency context).",
                      "minLength": 1,
                      "maxLength": 16
                    },
                    "arg_key": {
                      "type": "string",
                      "description": "Name of the argument field that contains the amount. Top-level only in v3.",
                      "minLength": 1,
                      "maxLength": 64,
                      "pattern": "^[A-Za-z0-9_\\-\\.]{1,64}$"
                    }
                  }
                }
              ]
            },

            "notes": {
              "type": "string",
              "description": "Optional short notes for humans. Not used for enforcement.",
              "maxLength": 512
            }
          }
        },

        "limits": {
          "type": "object",
          "additionalProperties": false,
          "description": "Hard size limits to protect LLM context budgets. CLI/server should enforce and reject oversize manifests.",
          "required": ["max_description_chars", "max_constraints_notes_chars"],
          "properties": {
            "max_description_chars": {
              "type": "integer",
              "minimum": 100,
              "maximum": 2000,
              "default": 800
            },
            "max_constraints_notes_chars": {
              "type": "integer",
              "minimum": 0,
              "maximum": 512,
              "default": 256
            }
          }
        }
      }
    }
  },

  "allOf": [
    {
      "description": "Require exactly one of parameters or input_schema.",
      "oneOf": [
        { "required": ["parameters"], "not": { "required": ["input_schema"] } },
        { "required": ["input_schema"], "not": { "required": ["parameters"] } }
      ]
    }
  ]
}
